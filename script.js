document.addEventListener("DOMContentLoaded", () => {
  const toggle = document.getElementById("protocol-toggle");
  const loader = document.getElementById("protocol-loader");
  const html = document.documentElement;
  const progressBar = document.getElementById("progressBar");
  const orbs = document.querySelectorAll(".orb-wrapper");

  // Initial Loader
  if (loader) {
    setTimeout(() => {
      loader.style.opacity = "0";
      setTimeout(() => loader.style.display = "none", 500);
    }, 1000);
  }

  // Theme Switcher
  if (toggle) {
    const savedTheme = localStorage.getItem("dte-theme") || "blue";
    html.setAttribute("data-theme", savedTheme);
    toggle.checked = savedTheme === "yellow";

    toggle.addEventListener("change", () => {
      loader.style.display = "flex";
      loader.style.opacity = "1";
      const newTheme = toggle.checked ? "yellow" : "blue";
      setTimeout(() => {
        html.setAttribute("data-theme", newTheme);
        localStorage.setItem("dte-theme", newTheme);
        
        // Re-initialize particles with new theme colors
        if (window.particles) {
            window.particles.destroy();
        }
        initParticles();

        loader.style.opacity = "0";
        setTimeout(() => loader.style.display = "none", 500);
      }, 800);
    });
  }

  // --- REFINED WORD-BY-WORD REVEAL ---
  let globalWordIndex = 0;
  document.querySelectorAll(".about-reveal").forEach((el) => {
    const content = el.innerHTML;
    const newContent = content
      .split(/(\s+|<[^>]+>)/g)
      .map((part) => {
        if (!part.trim() || part.startsWith("<")) return part;
        return `<span class="reveal-word">${part}</span>`;
      })
      .join("");
    el.innerHTML = newContent;

    const words = el.querySelectorAll(".reveal-word");
    words.forEach((word, i) => {
      word.style.transitionDelay = `${i * 35}ms`;
    });
  });

  // Smooth Section & Word Reveals
  const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        entry.target.classList.add("visible");
      }
    });
  }, { threshold: 0.15 });

  document.querySelectorAll(".section-title, .project-card, .about-content, .about-reveal").forEach(el => {
    observer.observe(el);
  });

  // Scroll Progress and Orb Activity
  window.addEventListener("scroll", () => {
    const winScroll = document.body.scrollTop || document.documentElement.scrollTop;
    const height = document.documentElement.scrollHeight - document.documentElement.clientHeight;
    const scrolled = (winScroll / height) * 100;
    if (progressBar) progressBar.style.height = scrolled + "%";

    const sections = ["home", "about", "projects", "footer"];
    let currentSection = "home";

    sections.forEach(id => {
      const section = document.getElementById(id);
      if (section) {
        const sectionTop = section.offsetTop;
        if (winScroll >= sectionTop - 300) {
          currentSection = id;
        }
      }
    });

    orbs.forEach(orb => {
      orb.classList.toggle("active", orb.getAttribute("data-section") === currentSection);
    });
  });

  // Orb Click Navigation
  orbs.forEach(orb => {
    orb.addEventListener("click", () => {
      const targetId = orb.getAttribute("data-section");
      const targetElement = document.getElementById(targetId);
      if (targetElement) {
        targetElement.scrollIntoView({ behavior: "smooth" });
      }
    });
  });

  // Initialize Particles
  if (document.getElementById('projector')) {
    initParticles();
  }

  // Hamburger Menu Toggle
  const hamburger = document.getElementById("hamburger-trigger");
  const navLinksList = document.getElementById("navLinksList");
  
  if (hamburger && navLinksList) {
    hamburger.addEventListener("click", () => {
      hamburger.classList.toggle("is-active");
      navLinksList.classList.toggle("active");
      document.body.style.overflow = navLinksList.classList.contains("active") ? "hidden" : "";
    });

    // Close menu when clicking links
    navLinksList.querySelectorAll("a").forEach(link => {
      link.addEventListener("click", () => {
        hamburger.classList.remove("is-active");
        navLinksList.classList.remove("active");
        document.body.style.overflow = "";
      });
    });
  }
});

// Modal Logic
let isModalOpen = false;
function toggleModal() {
  const body = document.body;
  isModalOpen = !isModalOpen;
  body.classList.toggle("modal--open", isModalOpen);
}

// Contact Form
function contact(event) {
  event.preventDefault();
  const loading = document.querySelector(".modal__overlay--loading");
  const success = document.querySelector(".modal__overlay--success");
  
  if (loading) {
    loading.classList.remove("hidden");
    loading.style.display = "flex";
  }

  emailjs.sendForm("service_akgmg6r", "template_nx4fvkb", event.target, "zmPiRmxRkScwdiYFX")
    .then(() => {
      if (loading) loading.style.display = "none";
      if (success) {
        success.classList.remove("hidden");
        success.style.display = "flex";
      }
      setTimeout(() => {
        if (success) success.style.display = "none";
        if (isModalOpen) {
          toggleModal();
        }
        event.target.reset();
      }, 2000);
    })
    .catch(err => {
      if (loading) loading.style.display = "none";
      alert("Comms error. Direct uplink to: drew.t.ernst@gmail.com");
      console.error(err);
    });
}

// Particle Engine Logic
var ParticleEngine = (function() {
	'use strict';

	function ParticleEngine(canvas_id) {
		if (!(this instanceof ParticleEngine)) {
			return new ParticleEngine(canvas_id);
		}
		
		var _ParticleEngine = this;
        var isYellowTheme = document.documentElement.getAttribute('data-theme') === 'yellow';

		this.canvas_id = canvas_id;
		this.stage = new createjs.Stage(canvas_id);
		this.totalWidth = this.canvasWidth = document.getElementById(canvas_id).width = document.getElementById(canvas_id).offsetWidth;
		this.totalHeight = this.canvasHeight = document.getElementById(canvas_id).height = document.getElementById(canvas_id).offsetHeight;
		this.compositeStyle = "lighter";

        // Dynamic Colors based on theme
        var pColor1, pColor2, pColor3, lColor1, lColor2, lColor3;

        if (isYellowTheme) {
            // Graphite Scheme
            pColor1 = "#A3B18A"; // Soft Green
            pColor2 = "#E29578"; // Muted Pink
            pColor3 = "#84A59D"; // Muted Teal
            lColor1 = "#3D4042";
            lColor2 = "#A3B18A";
            lColor3 = "#E29578";
        } else {
            // Stormy Monochromatic Blue Scheme
            pColor1 = "#7DD3FC"; // Sky Blue
            pColor2 = "#94A3B8"; // Slate Gray
            pColor3 = "#38BDF8"; // Ocean Blue
            lColor1 = "#1E293B";
            lColor2 = "#334155";
            lColor3 = "#0F172A";
        }

		this.particleSettings = [{id:"small", num:300, fromX:0, toX:this.totalWidth, ballwidth:3, alphamax:0.4, areaHeight:.5, color:pColor1, fill:false}, 
								{id:"medium", num:100, fromX:0, toX:this.totalWidth,  ballwidth:8, alphamax:0.3, areaHeight:1, color:pColor2, fill:true}, 
								{id:"large", num:10, fromX:0, toX:this.totalWidth, ballwidth:30,  alphamax:0.2, areaHeight:1, color:pColor3, fill:true}];
		this.particleArray = [];
		this.lights = [{ellipseWidth:400, ellipseHeight:100, alpha:0.6, offsetX:0, offsetY:0, color:lColor1}, 
						{ellipseWidth:350, ellipseHeight:250, alpha:0.3, offsetX:-50, offsetY:0, color:lColor2}, 
						{ellipseWidth:100, ellipseHeight:80, alpha:0.2, offsetX:80, offsetY:-50, color:lColor3}];

		this.stage.compositeOperation = _ParticleEngine.compositeStyle;


		function drawBgLight()
		{
			var light;
			var bounds;
			var blurFilter;
			for (var i = 0, len = _ParticleEngine.lights.length; i < len; i++) {				
				light = new createjs.Shape();
				light.graphics.beginFill(_ParticleEngine.lights[i].color).drawEllipse(0, 0, _ParticleEngine.lights[i].ellipseWidth, _ParticleEngine.lights[i].ellipseHeight);
				light.regX = _ParticleEngine.lights[i].ellipseWidth/2;
				light.regY = _ParticleEngine.lights[i].ellipseHeight/2; 
				light.y = light.initY = _ParticleEngine.totalHeight/2 + _ParticleEngine.lights[i].offsetY;
				light.x = light.initX =_ParticleEngine.totalWidth/2 + _ParticleEngine.lights[i].offsetX;

				blurFilter = new createjs.BlurFilter(_ParticleEngine.lights[i].ellipseWidth, _ParticleEngine.lights[i].ellipseHeight, 1);
				bounds = blurFilter.getBounds();
				light.filters = [blurFilter];
				light.cache(bounds.x-_ParticleEngine.lights[i].ellipseWidth/2, bounds.y-_ParticleEngine.lights[i].ellipseHeight/2, bounds.width*2, bounds.height*2);
				light.alpha = _ParticleEngine.lights[i].alpha;

				light.compositeOperation = "screen";
				_ParticleEngine.stage.addChildAt(light, 0);

				_ParticleEngine.lights[i].elem = light;
			}

			TweenMax.fromTo(_ParticleEngine.lights[0].elem, 10, {scaleX:1.5, x:_ParticleEngine.lights[0].elem.initX, y:_ParticleEngine.lights[0].elem.initY},{yoyo:true, repeat:-1, ease:Power1.easeInOut, scaleX:2, scaleY:0.7});
			TweenMax.fromTo(_ParticleEngine.lights[1].elem, 12, { x:_ParticleEngine.lights[1].elem.initX, y:_ParticleEngine.lights[1].elem.initY},{delay:5, yoyo:true, repeat:-1, ease:Power1.easeInOut, scaleY:2, scaleX:2, y:_ParticleEngine.totalHeight/2-50, x:_ParticleEngine.totalWidth/2+100});
			TweenMax.fromTo(_ParticleEngine.lights[2].elem, 8, { x:_ParticleEngine.lights[2].elem.initX, y:_ParticleEngine.lights[2].elem.initY},{delay:2, yoyo:true, repeat:-1, ease:Power1.easeInOut, scaleY:1.5, scaleX:1.5, y:_ParticleEngine.totalHeight/2, x:_ParticleEngine.totalWidth/2-200});
		}
		
		var blurFilter;
		function drawParticles(){

			for (var i = 0, len = _ParticleEngine.particleSettings.length; i < len; i++) {
				var ball = _ParticleEngine.particleSettings[i];

				var circle;
				for (var s = 0; s < ball.num; s++ )
				{
					circle = new createjs.Shape();
					if(ball.fill){
						circle.graphics.beginFill(ball.color).drawCircle(0, 0, ball.ballwidth);
						blurFilter = new createjs.BlurFilter(ball.ballwidth/2, ball.ballwidth/2, 1);
						circle.filters = [blurFilter];
						var bounds = blurFilter.getBounds();
						circle.cache(-50+bounds.x, -50+bounds.y, 100+bounds.width, 100+bounds.height);
					}else{
						circle.graphics.beginStroke(ball.color).setStrokeStyle(1).drawCircle(0, 0, ball.ballwidth);
					}
					
					circle.alpha = range(0, 0.1);
					circle.alphaMax = ball.alphamax;
					circle.distance = ball.ballwidth * 2;
					circle.ballwidth = ball.ballwidth;
					circle.flag = ball.id;
					_ParticleEngine.applySettings(circle, ball.fromX, ball.toX, ball.areaHeight);
					circle.speed = range(2, 10);
					circle.y = circle.initY;
					circle.x = circle.initX;
					circle.scaleX = circle.scaleY = range(0.3, 1);

					_ParticleEngine.stage.addChild(circle);
					

					animateBall(circle);

					_ParticleEngine.particleArray.push(circle);
				}
			}	
		}

		this.applySettings = function(circle, positionX, totalWidth, areaHeight)
		{
			circle.speed = range(1, 3);
			circle.initY = weightedRange(0, _ParticleEngine.totalHeight , 1, [_ParticleEngine.totalHeight * (2-areaHeight/2)/4, _ParticleEngine.totalHeight*(2+areaHeight/2)/4], 0.8 );
			circle.initX = weightedRange(positionX, totalWidth, 1, [positionX+ ((totalWidth-positionX))/4, positionX+ ((totalWidth-positionX)) * 3/4], 0.6);
		}

		function animateBall(ball)
		{
			var scale = range(0.3, 1);
			var xpos = range(ball.initX - ball.distance, ball.initX + ball.distance);
			var ypos = range(ball.initY - ball.distance, ball.initY + ball.distance);
			var speed = ball.speed;
			TweenMax.to(ball, speed, {scaleX:scale, scaleY:scale, x:xpos, y:ypos, onComplete:animateBall, onCompleteParams:[ball], ease:Cubic.easeInOut});	
			TweenMax.to(ball, speed/2, {alpha:range(0.1, ball.alphaMax), onComplete:fadeout, onCompleteParams:[ball, speed]});	
		}	

		function fadeout(ball, speed)
		{
			ball.speed = range(2, 10);
			TweenMax.to(ball, speed/2, {alpha:0 });
		}

		drawBgLight();
		drawParticles();
	}

	ParticleEngine.prototype.render = function()
	{
		this.stage.update();
	}

	ParticleEngine.prototype.resize = function()
	{
		this.totalWidth = this.canvasWidth = document.getElementById(this.canvas_id).width = document.getElementById(this.canvas_id).offsetWidth;
		this.totalHeight = this.canvasHeight = document.getElementById(this.canvas_id).height = document.getElementById(this.canvas_id).offsetHeight;
		this.render();

		for (var i= 0, length = this.particleArray.length; i < length; i++)
		{
			this.applySettings(this.particleArray[i], 0, this.totalWidth, this.particleArray[i].areaHeight);
		}

		for (var j = 0, len = this.lights.length; j < len; j++) {
			this.lights[j].elem.initY = this.totalHeight/2 + this.lights[j].offsetY;
			this.lights[j].elem.initX =this.totalWidth/2 + this.lights[j].offsetX;
			TweenMax.to(this.lights[j].elem, .5, {x:this.lights[j].elem.initX, y:this.lights[j].elem.initY});			
		}
	}

    ParticleEngine.prototype.destroy = function() {
        createjs.Ticker.removeEventListener("tick", updateCanvasProxy);
        this.stage.removeAllChildren();
        this.stage.clear();
    }

	return ParticleEngine;

}());

function range(min, max) { return min + (max - min) * Math.random(); }
function round(num, precision) { var decimal = Math.pow(10, precision); return Math.round(decimal* num) / decimal; }
function weightedRange(to, from, decimalPlaces, weightedRange, weightStrength) {
	if (typeof from === "undefined" || from === null) { from = 0; }
	if (typeof decimalPlaces === "undefined" || decimalPlaces === null) { decimalPlaces = 0; }
	if (typeof weightedRange === "undefined" || weightedRange === null) { weightedRange = 0; }
	if (typeof weightStrength === "undefined" || weightStrength === null) { weightStrength = 0; }
	var ret;
	if(to == from){return(to);}
	if(weightedRange && Math.random()<=weightStrength){
		ret = round( Math.random()*(weightedRange[1]-weightedRange[0]) + weightedRange[0], decimalPlaces )
	}else{
		ret = round( Math.random()*(to-from)+from, decimalPlaces )
	}
	return(ret);
}

var updateCanvasProxy;
function initParticles() {
	window.particles = new ParticleEngine('projector');
    updateCanvasProxy = function() { window.particles.render(); };
	createjs.Ticker.addEventListener("tick", updateCanvasProxy);
	window.addEventListener('resize', function() { window.particles.resize(); }, false);
}
